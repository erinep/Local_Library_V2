{% extends "base.html" %}
{% block content %}
  <section class="hero">
    <div class="card">
      <h2>Recommendations</h2>
      <form
        method="get"
        action="/ui/recommendations#results"
        class="recommendations-form"
        data-active="{% if selected['Genre'] or selected['Pacing'] or selected['Reader']
          or selected['Romance'] or selected['Scale'] or selected['Series']
          or selected['Setting'] or selected['Spice'] or selected['StoryEngine']
          or selected['Tone'] or selected['Topic'] %}true{% else %}false{% endif %}"
      >
        <p class="note">Select one or more per category. Leave blank to include all.</p>
        <div class="tag-form rec-namespace">
          {% for ns in namespace_config %}
            <div class="rec-group" data-rec-group>
              <div class="rec-group-title">{{ ns['ui_label'] }}</div>
              {% for tag in grouped[ns['tag_prefix']] %}
                <label class="rec-option">
                  <input
                    type="checkbox"
                    name="{{ ns['query_param'] }}"
                    value="{{ tag['id'] }}"
                    {% if tag['id'] in selected[ns['tag_prefix']] %}checked{% endif %}
                  />
                  {{ tag['display_name'] }}
                </label>
              {% endfor %}
            </div>
          {% endfor %}
          <div class="rec-group rec-group-topics" data-rec-group data-rec-topic>
            <div class="rec-group-title">Topics</div>
            <div class="tag-form">
              <input
                class="input"
                type="text"
                list="topic-options"
                name="topic_query"
                placeholder="Search topics"
                autocomplete="off"
                data-topic-input
              />
              <button class="btn btn-outline btn-small" type="button" data-topic-add>Add</button>
            </div>
            <div class="topic-suggest" data-topic-suggest hidden>
              {% for tag in topics %}
                <button
                  class="topic-suggest-item"
                  type="button"
                  data-topic-id="{{ tag['id'] }}"
                  data-topic-label="{{ tag['display_name'] }}"
                >
                  {{ tag['display_name'] }}
                </button>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="tag-list tag-list-topics" data-topic-badges>
          {% for tag in topics %}
            {% if tag['id'] in selected["Topic"] %}
              <div class="tag-pill" data-topic-id="{{ tag['id'] }}">
                <span>{{ tag['display_name'] }}</span>
                <button class="tag-remove" type="button" aria-label="Remove topic {{ tag['display_name'] }}">&times;</button>
                <input type="hidden" name="topic_id" value="{{ tag['id'] }}" />
              </div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="tag-form">
          <button class="btn btn-outline btn-small" type="submit">Search</button>
          <a
            class="btn btn-small"
            href="/ui/recommendations"
            data-clear-filters
            {% if not selected["Genre"] and not selected["Pacing"] and not selected["Reader"] and not selected["Romance"]
              and not selected["Scale"] and not selected["Series"] and not selected["Setting"] and not selected["Spice"]
              and not selected["StoryEngine"] and not selected["Tone"] and not selected["Topic"] %}hidden{% endif %}
          >
            Clear
          </a>
        </div>
        <p class="note note-active">Active filters applied.</p>
      </form>
    </div>
  </section>

  <section class="section" id="results">
    <div class="card">
      <h3>Matches</h3>
      <p class="note">{{ summary }}</p>
      <p class="note">{{ books | length }} results</p>
      <div class="list">
        {% for book in books %}
          <div class="list-item">
            <div>
              <a href="/ui/books/{{ book['id'] }}">{{ book['title'] }}</a><br />
              <small>{{ book['author'] or "Unknown author" }}</small>
            </div>
            <span class="badge">{{ book['file_count'] }} files</span>
          </div>
        {% else %}
          <p class="note">No matching books yet.</p>
        {% endfor %}
      </div>
    </div>
  </section>
{% endblock %}
{% block scripts %}
  <script>
    const clearButton = document.querySelector("[data-clear-filters]");
    const recForm = document.querySelector(".recommendations-form");
    const topicInput = document.querySelector("[data-topic-input]");
    const topicAddButton = document.querySelector("[data-topic-add]");
    const topicBadges = document.querySelector("[data-topic-badges]");
    const topicSuggest = document.querySelector("[data-topic-suggest]");
    let activeSuggestIndex = -1;

    const addTopicBadge = (topicId, label) => {
      if (!topicBadges) return;
      if (topicBadges.querySelector(`[data-topic-id='${topicId}']`)) {
        return;
      }
      const pill = document.createElement("div");
      pill.className = "tag-pill";
      pill.dataset.topicId = topicId;

      const text = document.createElement("span");
      text.textContent = label;

      const remove = document.createElement("button");
      remove.className = "tag-remove";
      remove.type = "button";
      remove.setAttribute("aria-label", `Remove topic ${label}`);
      remove.textContent = "x";
      remove.addEventListener("click", () => {
        pill.remove();
        updateClearState();
      });

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "topic_id";
      input.value = topicId;

      pill.appendChild(text);
      pill.appendChild(remove);
      pill.appendChild(input);
      topicBadges.appendChild(pill);
    };

    const normalizeText = (value) => value.toLowerCase().trim();

    const handleAddTopic = (topicId, label) => {
      if (!topicId || !label) {
        return;
      }
      addTopicBadge(topicId, label);
      updateClearState();
      updateGroupHighlights();
      if (topicInput) {
        topicInput.value = "";
      }
      if (topicSuggest) {
        topicSuggest.setAttribute("hidden", "");
      }
    };

    const filterSuggestions = () => {
      if (!topicInput || !topicSuggest) return;
      const query = normalizeText(topicInput.value);
      const items = topicSuggest.querySelectorAll(".topic-suggest-item");
      let visible = 0;
      items.forEach((item) => {
        const label = item.dataset.topicLabel || "";
        const matches = !query || normalizeText(label).includes(query);
        item.toggleAttribute("hidden", !matches);
        if (matches) {
          visible += 1;
        }
      });
      activeSuggestIndex = -1;
      items.forEach((item) => item.classList.remove("is-active"));
      if (visible > 0) {
        topicSuggest.removeAttribute("hidden");
      } else {
        topicSuggest.setAttribute("hidden", "");
      }
    };

    const updateClearState = () => {
      if (!clearButton || !recForm) return;
      const inputs = recForm.querySelectorAll("input[type='checkbox']");
      const hasTopics = topicBadges
        ? topicBadges.querySelectorAll("input[name='topic_id']").length > 0
        : false;
      let hasSelection = hasTopics;
      inputs.forEach((input) => {
        if (!hasSelection && input.checked) {
          hasSelection = true;
        }
      });
      clearButton.toggleAttribute("hidden", !hasSelection);
    };

    const updateGroupHighlights = () => {
      if (!recForm) return;
      const groups = recForm.querySelectorAll("[data-rec-group]");
      groups.forEach((group) => {
        const isTopicGroup = group.hasAttribute("data-rec-topic");
        let isActive = false;
        if (isTopicGroup) {
          isActive = !!(topicBadges && topicBadges.querySelector("input[name='topic_id']"));
        } else {
          const checked = group.querySelector("input[type='checkbox']:checked");
          isActive = !!checked;
        }
        group.toggleAttribute("data-active", isActive);
      });
    };

    if (recForm) {
      recForm.addEventListener("change", () => {
        updateClearState();
        updateGroupHighlights();
      });
      updateClearState();
      updateGroupHighlights();
    }

    if (topicInput) {
      topicInput.addEventListener("focus", filterSuggestions);
      topicInput.addEventListener("input", filterSuggestions);
      topicInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          const active = topicSuggest?.querySelector(".topic-suggest-item.is-active");
          const fallback = topicSuggest?.querySelector(".topic-suggest-item:not([hidden])");
          const chosen = active || fallback;
          if (chosen) {
            handleAddTopic(chosen.dataset.topicId, chosen.dataset.topicLabel || "");
          }
          return;
        }
        if (event.key === "ArrowDown" || event.key === "ArrowUp") {
          event.preventDefault();
          if (!topicSuggest) return;
          const items = Array.from(topicSuggest.querySelectorAll(".topic-suggest-item:not([hidden])"));
          if (!items.length) return;
          if (event.key === "ArrowDown") {
            activeSuggestIndex = (activeSuggestIndex + 1) % items.length;
          } else {
            activeSuggestIndex = (activeSuggestIndex - 1 + items.length) % items.length;
          }
          items.forEach((item) => item.classList.remove("is-active"));
          const current = items[activeSuggestIndex];
          current.classList.add("is-active");
          current.scrollIntoView({ block: "nearest" });
        }
      });
    }

    if (topicSuggest) {
      topicSuggest.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (!target.dataset.topicId) {
          return;
        }
        handleAddTopic(target.dataset.topicId, target.dataset.topicLabel || "");
      });
    }

    if (topicAddButton) {
      topicAddButton.addEventListener("click", () => {
        if (!topicInput || !topicSuggest) return;
        const query = normalizeText(topicInput.value);
        if (!query) return;
        const match = Array.from(topicSuggest.querySelectorAll(".topic-suggest-item")).find((item) => {
          const label = item.dataset.topicLabel || "";
          return normalizeText(label) === query;
        });
        if (match) {
          handleAddTopic(match.dataset.topicId, match.dataset.topicLabel || "");
        }
      });
    }

    if (recForm) {
      recForm.addEventListener("change", updateGroupHighlights);
    }

    document.addEventListener("click", (event) => {
      if (!topicSuggest) return;
      if (!topicInput) return;
      const target = event.target;
      if (target === topicInput || topicSuggest.contains(target)) {
        return;
      }
      topicSuggest.setAttribute("hidden", "");
    });
  </script>
{% endblock %}



