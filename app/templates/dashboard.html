{% extends "base.html" %}
{% block content %}
  <section class="hero">
    <div class="card">
      <h2>Library Totals</h2>
      <p><strong id="total-books">{{ totals["books"] }}</strong> books</p>
      <p><strong id="total-authors">{{ totals["authors"] }}</strong> authors</p>
      <p><strong id="total-files">{{ totals["files"] }}</strong> files</p>
    </div>
    <div class="card">
      <h2>Quick Actions</h2>
      <button class="btn" type="button" data-scan>Run scan</button>
      <p class="note" id="scan-status">Idle</p>
      <button class="btn btn-outline" type="button" data-reset>Clear database</button>
      <p class="note" id="reset-status">This deletes all indexed data.</p>
      <button class="btn btn-outline" type="button" data-reset-tags>Clear tags</button>
      <p class="note" id="reset-tags-status">This deletes all tags and tag links.</p>
    </div>
    <div class="card">
      <h2>Issues Inbox</h2>
      <p class="note">No issues are tracked yet.</p>
    </div>
  </section>

  <section class="section">
    <div class="card">
      <h3>Recent Activity</h3>
      <div class="list" id="activity-list">
        {% for entry in activity %}
          <div class="list-item">
            <div>
              <strong>{{ entry["event_type"] }}</strong><br />
              <small>{{ entry["result"] or "No result" }}</small>
            </div>
            <span class="badge">{{ entry["created_at"] }}</span>
          </div>
        {% else %}
          <p class="note">No activity yet.</p>
        {% endfor %}
      </div>
    </div>
  </section>
{% endblock %}
{% block scripts %}
  <script>
    const scanButton = document.querySelector("[data-scan]");
    const scanStatus = document.getElementById("scan-status");
    const activityList = document.getElementById("activity-list");
    const totalBooks = document.getElementById("total-books");
    const totalAuthors = document.getElementById("total-authors");
    const totalFiles = document.getElementById("total-files");

    const refreshDashboard = async () => {
      const response = await fetch("/ui/summary");
      if (!response.ok) {
        throw new Error(`Summary failed: ${response.status}`);
      }
      const data = await response.json();
      if (totalBooks) totalBooks.textContent = data.totals.books;
      if (totalAuthors) totalAuthors.textContent = data.totals.authors;
      if (totalFiles) totalFiles.textContent = data.totals.files;

      if (activityList) {
        activityList.innerHTML = "";
        if (data.activity.length === 0) {
          const empty = document.createElement("p");
          empty.className = "note";
          empty.textContent = "No activity yet.";
          activityList.appendChild(empty);
        } else {
          data.activity.forEach((entry) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.innerHTML = `
              <div>
                <strong>${entry.event_type}</strong><br />
                <small>${entry.result || "No result"}</small>
              </div>
              <span class="badge">${entry.created_at}</span>
            `;
            activityList.appendChild(item);
          });
        }
      }
    };

    if (scanButton && scanStatus) {
      scanButton.addEventListener("click", async () => {
        scanButton.disabled = true;
        scanStatus.textContent = "Scanning...";
        try {
          const response = await fetch("/scan", { method: "POST" });
          if (!response.ok) {
            throw new Error(`Scan failed: ${response.status}`);
          }
          const result = await response.json();
          scanStatus.textContent = `Indexed ${result.indexed} files at ${result.scanned_at}`;
          await refreshDashboard();
        } catch (error) {
          scanStatus.textContent = "Scan failed. Check server logs.";
        } finally {
          scanButton.disabled = false;
        }
      });
    }

    const resetButton = document.querySelector("[data-reset]");
    const resetStatus = document.getElementById("reset-status");
    const resetTagsButton = document.querySelector("[data-reset-tags]");
    const resetTagsStatus = document.getElementById("reset-tags-status");

    if (resetButton && resetStatus) {
      resetButton.addEventListener("click", async () => {
        const confirmed = window.confirm("Clear the library database? This cannot be undone.");
        if (!confirmed) {
          return;
        }
        resetButton.disabled = true;
        resetStatus.textContent = "Clearing...";
        try {
          const response = await fetch("/ui/reset", { method: "POST" });
          if (!response.ok) {
            throw new Error(`Reset failed: ${response.status}`);
          }
          resetStatus.textContent = "Database cleared. Run a new scan.";
          await refreshDashboard();
        } catch (error) {
          resetStatus.textContent = "Reset failed. Check server logs.";
        } finally {
          resetButton.disabled = false;
        }
      });
    }

    if (resetTagsButton && resetTagsStatus) {
      resetTagsButton.addEventListener("click", async () => {
        const confirmed = window.confirm("Clear all tags? This cannot be undone.");
        if (!confirmed) {
          return;
        }
        resetTagsButton.disabled = true;
        resetTagsStatus.textContent = "Clearing...";
        try {
          const response = await fetch("/ui/reset-tags", { method: "POST" });
          if (!response.ok) {
            throw new Error(`Reset failed: ${response.status}`);
          }
          resetTagsStatus.textContent = "Tags cleared.";
          await refreshDashboard();
        } catch (error) {
          resetTagsStatus.textContent = "Reset failed. Check server logs.";
        } finally {
          resetTagsButton.disabled = false;
        }
      });
    }
  </script>
{% endblock %}
